<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Demo V6 ‚Äì Ganader√≠a Satelital (Pastoreo PV6)</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<link href="style.css" rel="stylesheet"/>
<style>
    /* (Tu CSS inline actual tal cual) */
    .legend{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:12px;color:#374151;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .legend .item{display:flex;align-items:center;gap:6px;margin:4px 0}
    .legend .sw{display:inline-block;width:16px;height:10px;border-radius:3px;border:1px solid #d1d5db}
    .map-label{background:rgba(255,255,255,.85);border:1px solid #d1d5db;border-radius:6px;padding:1px 4px;color:#111;font-weight:600}
    .dsl-label{background:#0ea5e950;color:#083344;border:1px solid #67e8f9;border-radius:10px;padding:1px 6px;font-weight:700}
    .btn{border:1px solid #cbd5e1;border-radius:8px;padding:6px 10px;cursor:pointer;background:#fff}
    .btn.secondary{background:#f8fafc}
    .topbar{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #e5e7eb;background:#fff;position:sticky;top:0;z-index:9}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{font-size:22px}
    .kpis{display:grid;grid-template-columns:repeat(6, minmax(120px,1fr));gap:10px;align-items:stretch;padding:8px 12px}
    .kpis .kpi{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
    .kpi-label{font-size:12px;color:#475569}
    .kpi-value{font-weight:700;font-size:16px;margin-top:2px}
    .toolbar .row{display:flex;flex-wrap:wrap;gap:8px;align-items:end;padding:8px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc}
    .toolbar label{display:block;font-size:12px;color:#475569;margin-bottom:2px}
    .main{display:grid;grid-template-columns:1.3fr .9fr;gap:10px;padding:10px}
    #map{height:68vh;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,.05);border:1px solid #e5e7eb}
    .side{display:flex;flex-direction:column;gap:10px}
    .card,.panel{background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    .card-header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #e5e7eb}
    .chart-wrap{height:260px;padding:6px 10px}
    .rank{width:100%;border-collapse:collapse;font-size:12px}
    .rank th,.rank td{padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:center}
    .rank thead th{position:sticky;top:0;background:#fff;z-index:1}
    .badge{padding:2px 8px;border-radius:10px;font-weight:600}
    .badge.ok{background:#dcfce7;color:#14532d;border:1px solid #86efac}
    .badge.no{background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca}
    .state.green{color:#16a34a;font-weight:700}
    .state.yellow{color:#d97706;font-weight:700}
    .state.red{color:#dc2626;font-weight:700}
    .pastoreo-dynamic{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pastoreo-dynamic .pill{font-size:12px;color:#0b3b2e;background:#e8f5e9;border:1px dashed #16a34a;border-radius:999px;padding:3px 8px;margin:6px 0;display:inline-block}
    .pastoreo-dynamic .pill.state-green{background:#dbf4e8;color:#064e3b}
    .chips{display:flex;gap:6px;flex-wrap:wrap;padding:4px}
    .chip{display:flex;align-items:center;gap:6px;border:1.5px solid #cbd5e1;border-radius:999px;padding:2px 8px;background:#fff;cursor:pointer}
    .chip small{opacity:.8}
    #sim-card label{display:flex;flex-direction:column;font-size:12px;color:#475569}
    #sim-card input{padding:6px 8px;border:1px solid #d0d7e2;border-radius:8px}
    #exc-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000}
    #exc-modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.3)}
    #exc-modal .card{position:relative;background:#fff;border-radius:12px;min-width:420px;max-width:92vw;max-height:80vh;overflow:auto;padding:12px;border:1px solid #e5e7eb;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    #exc-modal h4{margin:0 0 8px 0}
    #exc-list{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    #exc-list label{display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;padding:6px;border-radius:8px}
  </style>
</head>
<body>
<!-- (Tu cuerpo tal cual) -->
<header class="topbar">
<div class="brand">
<span class="logo">üåø</span>
<div class="brand-txt">
<strong>Demo V6</strong>
<small>Modelo √âtico Pastoril ¬∑ Kg MS/ha</small>
</div>
</div>
<div class="kpis kpis-finca">
<div class="kpi"><div class="kpi-label">Kg MS/ha ponderado (Finca)</div><div class="kpi-value" id="kpi-biomasa-finca">‚Äì</div></div>
<div class="kpi"><div class="kpi-label">√Årea total (Finca)</div><div class="kpi-value" id="kpi-area-finca">‚Äì</div></div>
<div class="kpi"><div class="kpi-label">UA efectiva (Finca)</div><div class="kpi-value" id="kpi-ua-finca">‚Äì</div></div>
<div class="kpi"><div class="kpi-label">Oferta utilizable (Finca)</div><div class="kpi-value" id="kpi-oferta-finca">‚Äì</div></div>
<div class="kpi"><div class="kpi-label">Demanda diaria (Finca)</div><div class="kpi-value" id="kpi-demanda-finca">‚Äì</div></div>
<div class="kpi"><div class="kpi-label">D√≠as recomendados (Finca)</div><div class="kpi-value" id="kpi-dias-finca">‚Äì</div></div>
</div>
</header>
<section class="kpis kpis-potrero">
<div class="kpi"><div class="kpi-label">Potrero seleccionado</div><div class="kpi-value" id="kpi-potrero-nombre">‚Äî</div></div>
<div class="kpi"><div class="kpi-label">Kg MS/ha (Potrero)</div><div class="kpi-value" id="kpi-biomasa-pot">‚Äî</div></div>
<div class="kpi"><div class="kpi-label">√Årea (ha)</div><div class="kpi-value" id="kpi-area-pot">‚Äî</div></div>
<div class="kpi"><div class="kpi-label">UA efectiva (Potrero)</div><div class="kpi-value" id="kpi-ua-pot">‚Äî</div></div>
<div class="kpi"><div class="kpi-label">Oferta utilizable (Potrero)</div><div class="kpi-value" id="kpi-oferta-pot">‚Äî</div></div>
<div class="kpi"><div class="kpi-label">D√≠as recomendados (Potrero)</div><div class="kpi-value" id="kpi-dias-pot">‚Äî</div></div>
</section>
<section class="toolbar">
<div class="row">
<div>
<label>Fecha: desde</label>
<input id="date-start" type="date"/>
</div>
<div>
<label>hasta</label>
<input id="date-end" type="date"/>
</div>
<div>
<label>Potreros</label>
<select id="pot-select">
<option value="__ALL__">Todos (finca)</option>
<option value="__PADRES__">Padres</option>
</select>
</div>
<div>
<label>Overlay</label>
<select id="overlay">
<option selected="" value="biomasa">Kg MS/ha</option>
<option value="kg_proj">Kg proyectado (consumo)</option>
<option value="estado">Estado (pastoreo)</option>
<option value="descanso">Descanso (d√≠as)</option>
<option value="pet0">P‚ÄìET‚ÇÄ (mm, 7d)</option>
</select>
</div>
<div>
<label>Fuente</label>
<select id="fuente">
<option selected="" value="smoothed">kgms_7d</option>
<option value="raw">kgms_raw</option>
</select>
</div>
<div>
<label>Modo manejo</label>
<select id="mode">
<option selected="" value="eq">Equilibrado</option>
<option value="gain">Ganancia Animal</option>
<option value="etico">√âtico Pastoril</option>
</select>
</div>
<div>
<label>Coef. uso (%)</label>
<input id="coef-uso" max="100" min="0" step="1" type="number" value="60"/>
</div>
<div>
<label>Consumo base (kg/UA/d)</label>
<input id="consumo" min="0" step="0.1" type="number" value="10"/>
</div>
<button class="btn" id="btn-apply">Aplicar</button>
<button class="btn" id="btn-params">Par√°metros</button>
<button class="btn" id="btn-export-day">Exportar CSV (d√≠a)</button>
<button class="btn secondary" id="btn-exc">Exclusiones</button>
</div>
</section>
<main class="main">
<div id="map"></div>
<aside class="side">
<section class="pastoreo-dynamic">
<div>
<div class="pill state-green">Ocupados</div>
<div class="chips" id="chips-green"></div>
</div>
<div>
<div class="pill">Libres calificados</div>
<div class="chips" id="chips-yellow"></div>
</div>
</section>
<div class="card" id="sim-card">
<div class="card-header">
<h4>Simular pastoreo (sin manejo)</h4>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 8px 8px 8px">
<label>PV total (kg)<input id="sim-pv" min="0" step="1" type="number"/></label>
<label>UA<input id="sim-ua" min="0" step="0.1" type="number"/></label>
<label>N total<input id="sim-n" min="0" step="1" type="number"/></label>
</div>
<div style="display:flex;gap:8px;padding:0 8px 10px 8px">
<button class="btn" id="btn-sim-run">Simular</button>
<button class="btn secondary" id="btn-sim-export">Descargar CSV (Top sugeridos)</button>
</div>
<div class="table-wrap" style="max-height:28vh;overflow:auto;margin:0 8px 10px 8px">
<table class="rank">
<thead>
<tr>
<th>Potrero</th>
<th>Kg MS/ha</th>
<th>D√≠as br. (est)</th>
<th>D√≠as aj. (est)</th>
<th>Estado</th>
</tr>
</thead>
<tbody id="sim-body"></tbody>
</table>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Serie temporal (Kg MS/ha &amp; P‚ÄìETo)</h3>
<button class="btn secondary" id="expand-chart">Expandir</button>
</div>
<div class="chart-wrap">
<canvas id="timeseries"></canvas>
</div>
</div>
<div class="panel">
<div class="card-header">
<h4>Ranking de potreros (Pastoreo)</h4>
</div>
<div class="table-wrap" style="max-height:40vh;overflow:auto;padding:4px 8px">
<table class="rank">
<thead>
<tr>
<th>Potrero</th>
<th>Kg MS/ha</th>
<th>Pend.7d</th>
<th>FND</th>
<th>Descanso</th>
<th>Entrada</th>
<th>D√≠as br.</th>
<th>D√≠as aj.</th>
<th>Estado</th>
<th>Incl.</th>
</tr>
</thead>
<tbody id="rank-body"></tbody>
</table>
</div>
</div>
<section class="card" id="pv6-manejo-card"></section></aside>
</main>
<div id="exc-modal">
<div class="backdrop"></div>
<div class="card">
<h4>Excluir potreros del an√°lisis</h4>
<div id="exc-list"></div>
<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
<button class="btn" id="exc-cancel">Cancelar</button>
<button class="btn" id="exc-save">Guardar</button>
</div>
</div>
</div>
<!-- Libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- REGISTRO SW (nuevo) -->

<!-- Parche MOV (remoto) -->
<script>window.__PV6_SHEETS_MOV_URL__="https://docs.google.com/spreadsheets/d/e/2PACX-1vR_Rp6f-Xdv6RyWXQhY0uV1E5P3PBQpjMJIVrxeRAq4RCYMEzlqWY24Jltqstcp3uV79moaJc63d4cf/pub?gid=0&single=true&output=csv";</script>
<script src="pv6_mov_remote_patch.js?v=3.0"></script>

<!-- N√∫cleo -->
<script src="app.v6.js?v=V6"></script>

<!-- Addon manejo PV6 (inline, auto-scroll + observer para Ranking) -->
<script>
(function(){
  function ensurePanel(){
    let card = document.getElementById('pv6-manejo-floating');
    if (card) return card;
    card = document.createElement('section');
    card.id = 'pv6-manejo-floating';
    card.style.cssText = 'position:fixed; right:12px; bottom:12px; width:560px; max-height:60vh; overflow:auto; background:#fff; border:1px solid #e5e7eb; box-shadow:0 10px 25px rgba(0,0,0,.12); border-radius:16px; z-index:9999; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;';
    card.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #eceff3">
        <h3 style="margin:0;font-size:16px">Pastoreo con manejo (PV6)</h3>
        <div id="pv6-m2-status" style="font-size:12px;color:#6b7a8c">inicializando‚Ä¶</div>
      </div>
      <div style="padding:8px 12px">
        <div class="table-wrap" style="max-height:44vh;overflow:auto">
          <table class="rank" style="width:100%;border-collapse:collapse">
            <thead><tr>
              <th style="text-align:left;padding:6px 4px;border-bottom:1px solid #eee">Potrero</th>
              <th style="padding:6px 4px;border-bottom:1px solid #eee">Kg MS/ha</th>
              <th style="padding:6px 4px;border-bottom:1px solid #eee">D√≠as br.</th>
              <th style="padding:6px 4px;border-bottom:1px solid #eee">D√≠as FDN</th>
              <th style="padding:6px 4px;border-bottom:1px solid #eee">Œî desperd. (d)</th>
              <th style="padding:6px 4px;border-bottom:1px solid #eee">D√≠as aj.</th>
              <th style="padding:6px 4px;border-bottom:1px solid #eee">Estado</th>
            </tr></thead>
            <tbody id="pv6-m2-body"><tr><td colspan="7" style="padding:8px 4px;color:#6b7a8c">Panel cargado. Buscando ‚ÄúRanking de potreros (Pastoreo)‚Äù‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>`;
    document.body.appendChild(card);
    return card;
  }

  function fmt(n){ return (n==null||!isFinite(n)) ? '‚Äì' : (Math.round(n*10)/10).toLocaleString('es-CO'); }
  function daysFDN(f){ if (f==null||!isFinite(f)||f<=0) return null; const pct=(f<=1)?f*100:f; return 120/pct; }

  function findRankingHeader(){
    const match=/ranking\s+de\s+potreros/i;
    const nodes=[...document.querySelectorAll('h1,h2,h3,h4,.card-header,.card-title,[class*="heading"],[data-title]')];
    return nodes.find(el=>match.test((el.textContent||'').trim()))||null;
  }
  function findRankingContainer(){
    const hdr=findRankingHeader();
    if (hdr){
      const cont = hdr.closest('section, .card, .widget, .panel, div') || hdr.parentElement;
      if (cont) return cont;
    }
    // Fallback por cabeceras
    const tables=[...document.querySelectorAll('table')];
    for (const t of tables){
      const ths=[...t.querySelectorAll('thead th, thead td, tbody tr:first-child th, tbody tr:first-child td')].map(x=>(x.textContent||'').trim().toLowerCase());
      const ok = ths.some(x=>/potrero/.test(x)) && ths.some(x=>/kg\s*ms\/?ha|kgms\/?ha/i.test(x)) && ths.some(x=>/fnd/.test(x));
      if (ok) return t.closest('section, .card, .widget, .panel, div')||t.parentElement;
    }
    return null;
  }
  function readRanking(container){
    const table = container.querySelector('table') || container;
    const rows=[];
    [...table.querySelectorAll('tbody tr')].forEach(tr=>{
      const tds=tr.querySelectorAll('td,th'); if (tds.length<3) return;
      const nm=(tds[0].textContent||'').trim();
      const getNum=t=>t.replace(/[^\d.,-]/g,'').replace(/\.(?=\d{3}\b)/g,'').replace(',', '.');
      const txts=[...tds].map(td=>(td.textContent||'').trim());
      const kg = txts[1] ? parseFloat(getNum(txts[1])) : null;
      let fndStr = txts[3]||'';
      if(!/%/.test(fndStr)) fndStr = (txts.find(x=>/%/.test(x))||'');
      const fnd = fndStr ? parseFloat(getNum(fndStr)) : null;
      if (nm) rows.push({nm,kg,fnd});
    });
    return rows;
  }

  function renderFromRanking(){
    const status=document.getElementById('pv6-m2-status');
    const body=document.getElementById('pv6-m2-body');
    if (!status||!body) return false;

    const cont=findRankingContainer();
    if (!cont){ status.textContent='buscando ranking‚Ä¶'; return false; }

    const table=cont.querySelector('table')||cont;
    const rows=readRanking(cont);
    if (!rows.length){
      status.textContent='ranking encontrado, esperando filas‚Ä¶';
      return false;
    }

    status.textContent='[M2.17] listo ‚Äî fuente: ranking (DOM)';
    body.innerHTML='';
    rows.slice(0,30).forEach(r=>{
      const Dfdn=daysFDN(r.fnd);
      const beta=0.05, wmax=0.30;
      const delta=(Dfdn==null)?null:Math.min(wmax,beta*Dfdn);
      const Dbr=null; // sin UA/√°rea aqu√≠
      const Daj=(Dfdn==null)?null:Math.max(0,Dfdn-(delta||0));
      const estadoTxt=(r.kg==null)?'‚Äì':(r.kg>=2000&&r.kg<=3200)?'<span class="state green">Verde</span>':(r.kg>=1600)?'<span class="state yellow">Amarillo</span>':'<span class="state red">Rojo</span>';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td style="text-align:left;padding:6px 4px">${r.nm}</td>
        <td style="padding:6px 4px">${r.kg==null?'‚Äì':Math.round(r.kg).toLocaleString('es-CO')}</td>
        <td style="padding:6px 4px">${fmt(Dbr)}</td>
        <td style="padding:6px 4px">${fmt(Dfdn)}</td>
        <td style="padding:6px 4px">${fmt(delta)}</td>
        <td style="padding:6px 4px">${fmt(Daj)}</td>
        <td style="padding:6px 4px">${estadoTxt}</td>`;
      body.appendChild(tr);
    });
    return true;
  }

  function ensureVisibleAndObserve(){
    const hdr=findRankingHeader();
    if (hdr) { try{ hdr.scrollIntoView({behavior:'smooth', block:'center'}); }catch(_){ window.scrollBy(0,500); } }
    const cont=findRankingContainer();
    if (!cont) return null;

    // Observa aparici√≥n de filas en la tabla
    const table=cont.querySelector('table')||cont;
    const target=table.querySelector('tbody')||table;
    const mo=new MutationObserver(()=>renderFromRanking());
    mo.observe(target,{childList:true,subtree:true});
    return mo;
  }

  function start(){
    ensurePanel();
    const mo=ensureVisibleAndObserve();
    // reintenta hasta llenar
    const iv=setInterval(()=>{ if (renderFromRanking()) clearInterval(iv); }, 400);
    setTimeout(()=>clearInterval(iv), 15000);
    // recalcular en cambios de controles
    ['date-end','fuente','coef-uso','consumo','mode','btn-apply'].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      const ev=(id==='btn-apply')?'click':'change';
      el.addEventListener(ev, ()=>{ ensureVisibleAndObserve(); renderFromRanking(); });
    });
    // tambi√©n al hacer scroll (por si el ranking est√° fuera de vista)
    window.addEventListener('scroll', ()=>renderFromRanking(), {passive:true});
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', start);
  else start();
})();
</script>

</body>
</html>
