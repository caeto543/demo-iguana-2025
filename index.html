<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Demo V6 ‚Äì Ganader√≠a Satelital (Pastoreo PV6)</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<link href="style.css" rel="stylesheet"/>
<style>
    /* (Tu CSS inline actual tal cual) */
    .legend{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:12px;color:#374151;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .legend .item{display:flex;align-items:center;gap:6px;margin:4px 0}
    .legend .sw{display:inline-block;width:16px;height:10px;border-radius:3px;border:1px solid #d1d5db}
    .map-label{background:rgba(255,255,255,.85);border:1px solid #d1d5db;border-radius:6px;padding:1px 4px;color:#111;font-weight:600}
    .dsl-label{background:#0ea5e950;color:#083344;border:1px solid #67e8f9;border-radius:10px;padding:1px 6px;font-weight:700}
    .btn{border:1px solid #cbd5e1;border-radius:8px;padding:6px 10px;cursor:pointer;background:#fff}
    .btn.secondary{background:#f8fafc}
    .topbar{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #e5e7eb;background:#fff;position:sticky;top:0;z-index:9}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{font-size:22px}
    .kpis{display:grid;grid-template-columns:repeat(6, minmax(120px,1fr));gap:10px;align-items:stretch;padding:8px 12px}
    .kpis .kpi{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
    .kpi-label{font-size:12px;color:#475569}
    .kpi-value{font-weight:700;font-size:16px;margin-top:2px}
    .toolbar .row{display:flex;flex-wrap:wrap;gap:8px;align-items:end;padding:8px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc}
    .toolbar label{display:block;font-size:12px;color:#475569;margin-bottom:2px}
    .main{display:grid;grid-template-columns:1.3fr .9fr;gap:10px;padding:10px}
    #map{height:68vh;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,.05);border:1px solid #e5e7eb}
    .side{display:flex;flex-direction:column;gap:10px}
    .card,.panel{background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    .card-header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #e5e7eb}
    .chart-wrap{height:260px;padding:6px 10px}
    .rank{width:100%;border-collapse:collapse;font-size:12px}
    .rank th,.rank td{padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:center}
    .rank thead th{position:sticky;top:0;background:#fff;z-index:1}
    .badge{padding:2px 8px;border-radius:10px;font-weight:600}
    .badge.ok{background:#dcfce7;color:#14532d;border:1px solid #86efac}
    .badge.no{background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca}
    .state.green{color:#16a34a;font-weight:700}
    .state.yellow{color:#d97706;font-weight:700}
    .state.red{color:#dc2626;font-weight:700}
    .pastoreo-dynamic{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pastoreo-dynamic .pill{font-size:12px;color:#0b3b2e;background:#e8f5e9;border:1px dashed #16a34a;border-radius:999px;padding:3px 8px;margin:6px 0;display:inline-block}
    .pastoreo-dynamic .pill.state-green{background:#dbf4e8;color:#064e3b}
    .chips{display:flex;gap:6px;flex-wrap:wrap;padding:4px}
    .chip{display:flex;align-items:center;gap:6px;border:1.5px solid #cbd5e1;border-radius:999px;padding:2px 8px;background:#fff;cursor:pointer}
    .chip small{opacity:.8}
    #sim-card label{display:flex;flex-direction:column;font-size:12px;color:#475569}
    #sim-card input{padding:6px 8px;border:1px solid #d0d7e2;border-radius:8px}
    #exc-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000}
    #exc-modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.3)}
    #exc-modal .card{position:relative;background:#fff;border-radius:12px;min-width:420px;max-width:92vw;max-height:80vh;overflow:auto;padding:12px;border:1px solid #e5e7eb;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    #exc-modal h4{margin:0 0 8px 0}
    #exc-list{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    #exc-list label{display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;padding:6px;border-radius:8px}
  </style>
</head>
<body>
<!-- (Tu cuerpo tal cual) -->
<header class="topbar">
<div class="brand">
<span class="logo">üåø</span>
<div class="brand-txt">
<strong>Demo V6</strong>
<small>Modelo √âtico Pastoril ¬∑ Kg MS/ha</small>
</div>
</div>
<div class="kpis kpis-finca">
<div class="kpi"><div class="kpi-label">Kg MS/ha ponderado (Finca)</div><div class="kpi-value" id="kpi-biomasa-finca">‚Äì</div></div>
<div class="kpi"><div class="kpi-label">√Årea total (Finca)</div><div class="kpi-value" id="kpi-area-finca">‚Äì</div></div>
<div class="kpi"><div class="kpi-label">UA efectiva (Finca)</div><div class="kpi-value" id="kpi-ua-finca">‚Äì</div></div>
<div class="kpi"><div class="kpi-label">Oferta utilizable (Finca)</div><div class="kpi-value" id="kpi-oferta-finca">‚Äì</div></div>
<div class="kpi"><div class="kpi-label">Demanda diaria (Finca)</div><div class="kpi-value" id="kpi-demanda-finca">‚Äì</div></div>
<div class="kpi"><div class="kpi-label">D√≠as recomendados (Finca)</div><div class="kpi-value" id="kpi-dias-finca">‚Äì</div></div>
</div>
</header>
<section class="kpis kpis-potrero">
<div class="kpi"><div class="kpi-label">Potrero seleccionado</div><div class="kpi-value" id="kpi-potrero-nombre">‚Äî</div></div>
<div class="kpi"><div class="kpi-label">Kg MS/ha (Potrero)</div><div class="kpi-value" id="kpi-biomasa-pot">‚Äî</div></div>
<div class="kpi"><div class="kpi-label">√Årea (ha)</div><div class="kpi-value" id="kpi-area-pot">‚Äî</div></div>
<div class="kpi"><div class="kpi-label">UA efectiva (Potrero)</div><div class="kpi-value" id="kpi-ua-pot">‚Äî</div></div>
<div class="kpi"><div class="kpi-label">Oferta utilizable (Potrero)</div><div class="kpi-value" id="kpi-oferta-pot">‚Äî</div></div>
<div class="kpi"><div class="kpi-label">D√≠as recomendados (Potrero)</div><div class="kpi-value" id="kpi-dias-pot">‚Äî</div></div>
</section>
<section class="toolbar">
<div class="row">
<div>
<label>Fecha: desde</label>
<input id="date-start" type="date"/>
</div>
<div>
<label>hasta</label>
<input id="date-end" type="date"/>
</div>
<div>
<label>Potreros</label>
<select id="pot-select">
<option value="__ALL__">Todos (finca)</option>
<option value="__PADRES__">Padres</option>
</select>
</div>
<div>
<label>Overlay</label>
<select id="overlay">
<option selected="" value="biomasa">Kg MS/ha</option>
<option value="kg_proj">Kg proyectado (consumo)</option>
<option value="estado">Estado (pastoreo)</option>
<option value="descanso">Descanso (d√≠as)</option>
<option value="pet0">P‚ÄìET‚ÇÄ (mm, 7d)</option>
</select>
</div>
<div>
<label>Fuente</label>
<select id="fuente">
<option selected="" value="smoothed">kgms_7d</option>
<option value="raw">kgms_raw</option>
</select>
</div>
<div>
<label>Modo manejo</label>
<select id="mode">
<option selected="" value="eq">Equilibrado</option>
<option value="gain">Ganancia Animal</option>
<option value="etico">√âtico Pastoril</option>
</select>
</div>
<div>
<label>Coef. uso (%)</label>
<input id="coef-uso" max="100" min="0" step="1" type="number" value="60"/>
</div>
<div>
<label>Consumo base (kg/UA/d)</label>
<input id="consumo" min="0" step="0.1" type="number" value="10"/>
</div>
<button class="btn" id="btn-apply">Aplicar</button>
<button class="btn" id="btn-params">Par√°metros</button>
<button class="btn" id="btn-export-day">Exportar CSV (d√≠a)</button>
<button class="btn secondary" id="btn-exc">Exclusiones</button>
</div>
</section>
<main class="main">
<div id="map"></div>
<aside class="side">
<section class="pastoreo-dynamic">
<div>
<div class="pill state-green">Ocupados</div>
<div class="chips" id="chips-green"></div>
</div>
<div>
<div class="pill">Libres calificados</div>
<div class="chips" id="chips-yellow"></div>
</div>
</section>
<div class="card" id="sim-card">
<div class="card-header">
<h4>Simular pastoreo (sin manejo)</h4>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 8px 8px 8px">
<label>PV total (kg)<input id="sim-pv" min="0" step="1" type="number"/></label>
<label>UA<input id="sim-ua" min="0" step="0.1" type="number"/></label>
<label>N total<input id="sim-n" min="0" step="1" type="number"/></label>
</div>
<div style="display:flex;gap:8px;padding:0 8px 10px 8px">
<button class="btn" id="btn-sim-run">Simular</button>
<button class="btn secondary" id="btn-sim-export">Descargar CSV (Top sugeridos)</button>
</div>
<div class="table-wrap" style="max-height:28vh;overflow:auto;margin:0 8px 10px 8px">
<table class="rank">
<thead>
<tr>
<th>Potrero</th>
<th>Kg MS/ha</th>
<th>D√≠as br. (est)</th>
<th>D√≠as aj. (est)</th>
<th>Estado</th>
</tr>
</thead>
<tbody id="sim-body"></tbody>
</table>
</div>
</div>
<div class="card">
<div class="card-header">
<h3>Serie temporal (Kg MS/ha &amp; P‚ÄìETo)</h3>
<button class="btn secondary" id="expand-chart">Expandir</button>
</div>
<div class="chart-wrap">
<canvas id="timeseries"></canvas>
</div>
</div>
<div class="panel">
<div class="card-header">
<h4>Ranking de potreros (Pastoreo)</h4>
</div>
<div class="table-wrap" style="max-height:40vh;overflow:auto;padding:4px 8px">
<table class="rank">
<thead>
<tr>
<th>Potrero</th>
<th>Kg MS/ha</th>
<th>Pend.7d</th>
<th>FND</th>
<th>Descanso</th>
<th>Entrada</th>
<th>D√≠as br.</th>
<th>D√≠as aj.</th>
<th>Estado</th>
<th>Incl.</th>
</tr>
</thead>
<tbody id="rank-body"></tbody>
</table>
</div>
</div>
<section class="card" id="pv6-manejo-card"></section></aside>
</main>
<div id="exc-modal">
<div class="backdrop"></div>
<div class="card">
<h4>Excluir potreros del an√°lisis</h4>
<div id="exc-list"></div>
<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
<button class="btn" id="exc-cancel">Cancelar</button>
<button class="btn" id="exc-save">Guardar</button>
</div>
</div>
</div>
<!-- Libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- REGISTRO SW (nuevo) -->
<script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw_mov_remote.js?ver=1").then(() => {
        console.log("[MOV][sw] registrado");
      }).catch(e => console.warn("[MOV][sw] error registro", e));
      navigator.serviceWorker.addEventListener("message", (ev) => {
        const m = ev.data || {};
        if (m.kind === "MOV_PATCH_OK")  console.log(`[MOV][SW] intercept ‚Üí remoto OK (${m.rows} filas)`);
        if (m.kind === "MOV_PATCH_ERR") console.warn("[MOV][SW] intercept error:", m.msg);
      });
    }
 </script>
<!-- Parche MOV (remoto) -->
<script>window.__PV6_SHEETS_MOV_URL__ = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_Rp6f-Xdv6RyWXQhY0uV1E5P3PBQpjMJIVrxeRAq4RCYMEzlqWY24Jltqstcp3uV79moaJc63d4cf/pub?gid=0&single=true&output=csv";</script><script src="pv6_mov_remote_patch.js?v=2.0"></script>
<!-- N√∫cleo -->
<script src="app.v6.js?v=V6"></script>
<!-- √öNICO addon estable M2.16 -->

<script src="pv6_m2_addon_v216.js?v=2.2"></script></body>
</html>
