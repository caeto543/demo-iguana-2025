<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Demo V6 ‚Äì Ganader√≠a Satelital (Pastoreo PV6)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* (Tu CSS inline actual tal cual) */
    .legend{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:12px;color:#374151;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .legend .item{display:flex;align-items:center;gap:6px;margin:4px 0}
    .legend .sw{display:inline-block;width:16px;height:10px;border-radius:3px;border:1px solid #d1d5db}
    .map-label{background:rgba(255,255,255,.85);border:1px solid #d1d5db;border-radius:6px;padding:1px 4px;color:#111;font-weight:600}
    .dsl-label{background:#0ea5e950;color:#083344;border:1px solid #67e8f9;border-radius:10px;padding:1px 6px;font-weight:700}
    .btn{border:1px solid #cbd5e1;border-radius:8px;padding:6px 10px;cursor:pointer;background:#fff}
    .btn.secondary{background:#f8fafc}
    .topbar{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #e5e7eb;background:#fff;position:sticky;top:0;z-index:9}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{font-size:22px}
    .kpis{display:grid;grid-template-columns:repeat(6, minmax(120px,1fr));gap:10px;align-items:stretch;padding:8px 12px}
    .kpis .kpi{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
    .kpi-label{font-size:12px;color:#475569}
    .kpi-value{font-weight:700;font-size:16px;margin-top:2px}
    .toolbar .row{display:flex;flex-wrap:wrap;gap:8px;align-items:end;padding:8px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc}
    .toolbar label{display:block;font-size:12px;color:#475569;margin-bottom:2px}
    .main{display:grid;grid-template-columns:1.3fr .9fr;gap:10px;padding:10px}
    #map{height:68vh;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,.05);border:1px solid #e5e7eb}
    .side{display:flex;flex-direction:column;gap:10px}
    .card,.panel{background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    .card-header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #e5e7eb}
    .chart-wrap{height:260px;padding:6px 10px}
    .rank{width:100%;border-collapse:collapse;font-size:12px}
    .rank th,.rank td{padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:center}
    .rank thead th{position:sticky;top:0;background:#fff;z-index:1}
    .badge{padding:2px 8px;border-radius:10px;font-weight:600}
    .badge.ok{background:#dcfce7;color:#14532d;border:1px solid #86efac}
    .badge.no{background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca}
    .state.green{color:#16a34a;font-weight:700}
    .state.yellow{color:#d97706;font-weight:700}
    .state.red{color:#dc2626;font-weight:700}
    .pastoreo-dynamic{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pastoreo-dynamic .pill{font-size:12px;color:#0b3b2e;background:#e8f5e9;border:1px dashed #16a34a;border-radius:999px;padding:3px 8px;margin:6px 0;display:inline-block}
    .pastoreo-dynamic .pill.state-green{background:#dbf4e8;color:#064e3b}
    .chips{display:flex;gap:6px;flex-wrap:wrap;padding:4px}
    .chip{display:flex;align-items:center;gap:6px;border:1.5px solid #cbd5e1;border-radius:999px;padding:2px 8px;background:#fff;cursor:pointer}
    .chip small{opacity:.8}
    #sim-card label{display:flex;flex-direction:column;font-size:12px;color:#475569}
    #sim-card input{padding:6px 8px;border:1px solid #d0d7e2;border-radius:8px}
    #exc-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000}
    #exc-modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.3)}
    #exc-modal .card{position:relative;background:#fff;border-radius:12px;min-width:420px;max-width:92vw;max-height:80vh;overflow:auto;padding:12px;border:1px solid #e5e7eb;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    #exc-modal h4{margin:0 0 8px 0}
    #exc-list{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    #exc-list label{display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;padding:6px;border-radius:8px}
  </style>
</head>
<body>
  <!-- (Tu cuerpo con topbar, KPIs, mapa, paneles‚Ä¶ sin cambios) -->
  <header class="topbar">
    <div class="brand">
      <span class="logo">üåø</span>
      <div class="brand-txt">
        <strong>Demo V6</strong>
        <small>Modelo √âtico Pastoril ¬∑ Kg MS/ha</small>
      </div>
    </div>
    <div class="kpis kpis-finca">
      <div class="kpi"><div class="kpi-label">Kg MS/ha ponderado (Finca)</div><div id="kpi-biomasa-finca" class="kpi-value">‚Äì</div></div>
      <div class="kpi"><div class="kpi-label">√Årea total (Finca)</div><div id="kpi-area-finca" class="kpi-value">‚Äì</div></div>
      <div class="kpi"><div class="kpi-label">UA efectiva (Finca)</div><div id="kpi-ua-finca" class="kpi-value">‚Äì</div></div>
      <div class="kpi"><div class="kpi-label">Oferta utilizable (Finca)</div><div id="kpi-oferta-finca" class="kpi-value">‚Äì</div></div>
      <div class="kpi"><div class="kpi-label">Demanda diaria (Finca)</div><div id="kpi-demanda-finca" class="kpi-value">‚Äì</div></div>
      <div class="kpi"><div class="kpi-label">D√≠as recomendados (Finca)</div><div id="kpi-dias-finca" class="kpi-value">‚Äì</div></div>
    </div>
  </header>

  <section class="kpis kpis-potrero">
    <div class="kpi"><div class="kpi-label">Potrero seleccionado</div><div id="kpi-potrero-nombre" class="kpi-value">‚Äî</div></div>
    <div class="kpi"><div class="kpi-label">Kg MS/ha (Potrero)</div><div id="kpi-biomasa-pot" class="kpi-value">‚Äî</div></div>
    <div class="kpi"><div class="kpi-label">√Årea (ha)</div><div id="kpi-area-pot" class="kpi-value">‚Äî</div></div>
    <div class="kpi"><div class="kpi-label">UA efectiva (Potrero)</div><div id="kpi-ua-pot" class="kpi-value">‚Äî</div></div>
    <div class="kpi"><div class="kpi-label">Oferta utilizable (Potrero)</div><div id="kpi-oferta-pot" class="kpi-value">‚Äî</div></div>
    <div class="kpi"><div class="kpi-label">D√≠as recomendados (Potrero)</div><div id="kpi-dias-pot" class="kpi-value">‚Äî</div></div>
  </section>

  <section class="toolbar">
    <div class="row">
      <div>
        <label>Fecha: desde</label>
        <input type="date" id="date-start" />
      </div>
      <div>
        <label>hasta</label>
        <input type="date" id="date-end" />
      </div>
      <div>
        <label>Potreros</label>
        <select id="pot-select">
          <option value="__ALL__">Todos (finca)</option>
          <option value="__PADRES__">Padres</option>
        </select>
      </div>
      <div>
        <label>Overlay</label>
        <select id="overlay">
          <option value="biomasa" selected>Kg MS/ha</option>
          <option value="kg_proj">Kg proyectado (consumo)</option>
          <option value="estado">Estado (pastoreo)</option>
          <option value="descanso">Descanso (d√≠as)</option>
          <option value="pet0">P‚ÄìET‚ÇÄ (mm, 7d)</option>
        </select>
      </div>
      <div>
        <label>Fuente</label>
        <select id="fuente">
          <option value="smoothed" selected>kgms_7d</option>
          <option value="raw">kgms_raw</option>
        </select>
      </div>
      <div>
        <label>Modo manejo</label>
        <select id="mode">
          <option value="eq" selected>Equilibrado</option>
          <option value="gain">Ganancia Animal</option>
          <option value="etico">√âtico Pastoril</option>
        </select>
      </div>
      <div>
        <label>Coef. uso (%)</label>
        <input type="number" id="coef-uso" value="60" min="0" max="100" step="1" />
      </div>
      <div>
        <label>Consumo base (kg/UA/d)</label>
        <input type="number" id="consumo" value="10" min="0" step="0.1" />
      </div>
      <button id="btn-apply" class="btn">Aplicar</button>
      <button id="btn-params" class="btn">Par√°metros</button>
      <button id="btn-export-day" class="btn">Exportar CSV (d√≠a)</button>
      <button id="btn-exc" class="btn secondary">Exclusiones</button>
    </div>
  </section>

  <main class="main">
    <div id="map"></div>

    <aside class="side">
      <section class="pastoreo-dynamic">
        <div>
          <div class="pill state-green">Ocupados</div>
          <div id="chips-green" class="chips"></div>
        </div>
        <div>
          <div class="pill">Libres calificados</div>
          <div id="chips-yellow" class="chips"></div>
        </div>
      </section>

      <!-- Simulador sin manejo -->
      <div class="card" id="sim-card">
        <div class="card-header">
          <h4>Simular pastoreo (sin manejo)</h4>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 8px 8px 8px">
          <label>PV total (kg)<input type="number" id="sim-pv" min="0" step="1" /></label>
          <label>UA<input type="number" id="sim-ua" min="0" step="0.1" /></label>
          <label>N total<input type="number" id="sim-n" min="0" step="1" /></label>
        </div>
        <div style="display:flex;gap:8px;padding:0 8px 10px 8px">
          <button id="btn-sim-run" class="btn">Simular</button>
          <button id="btn-sim-export" class="btn secondary">Descargar CSV (Top sugeridos)</button>
        </div>
        <div class="table-wrap" style="max-height:28vh;overflow:auto;margin:0 8px 10px 8px">
          <table class="rank">
            <thead>
              <tr>
                <th>Potrero</th>
                <th>Kg MS/ha</th>
                <th>D√≠as br. (est)</th>
                <th>D√≠as aj. (est)</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="sim-body"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Serie temporal (Kg MS/ha & P‚ÄìETo)</h3>
          <button id="expand-chart" class="btn secondary">Expandir</button>
        </div>
        <div class="chart-wrap">
          <canvas id="timeseries"></canvas>
        </div>
      </div>

      <div class="panel">
        <div class="card-header">
          <h4>Ranking de potreros (Pastoreo)</h4>
        </div>
        <div class="table-wrap" style="max-height:40vh;overflow:auto;padding:4px 8px">
          <table class="rank">
            <thead>
              <tr>
                <th>Potrero</th>
                <th>Kg MS/ha</th>
                <th>Pend.7d</th>
                <th>FND</th>
                <th>Descanso</th>
                <th>Entrada</th>
                <th>D√≠as br.</th>
                <th>D√≠as aj.</th>
                <th>Estado</th>
                <th>Incl.</th>
              </tr>
            </thead>
            <tbody id="rank-body"></tbody>
          </table>
        </div>
      </div>
    </aside>
  </main>

  <!-- Modal exclusiones -->
  <div id="exc-modal">
    <div class="backdrop"></div>
    <div class="card">
      <h4>Excluir potreros del an√°lisis</h4>
      <div id="exc-list"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="exc-cancel" class="btn">Cancelar</button>
        <button id="exc-save" class="btn">Guardar</button>
      </div>
    </div>
  </div>

<!-- ORDEN CORRECTO DE SCRIPTS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- Define aqu√≠ la URL remota del MOV (Google Sheets publicado como CSV) -->
<script>
  // Pega tu URL publicada que termina en output=csv
  window.PV6_MOV_REMOTE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_Rp6f-Xdv6RyWXQhY0uV1E5P3PBQpjMJIVrxeRAq4RCYMEzlqWY24Jltqstcp3uV79moaJc63d4cf/pub?gid=0&single=true&output=csv";
</script>

<!-- Parche remoto: DESPU√âS de PapaParse y ANTES de app.v6.js -->
<script src="pv6_mov_remote_patch.js?v=1.3"></script>

<!-- Core y addons -->
<script src="app.v6.js?v=V6"></script>
<script src="pv6_m1_addon.js?v=1"></script>
<script src="pv6_m2_addon.js?v=2.2"></script>

<!-- (Opcional) evita el 404 del favicon -->
<link rel="icon" href="data:,">

